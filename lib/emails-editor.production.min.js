"use strict";function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var EMAIL_REGEXP=/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/;function validateEmail(e){return EMAIL_REGEXP.test(e)}function nodeListToArray(e){return Array.prototype.slice.call(e)}function escapeHtml(e){return(""+e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function isTextNode(e){return 3===e.nodeType}var ENTER_KEY=13,BACKSPACE_KEY=8,SEPARATOR='<br class="emails-editor-separator" />';function isEmailSeparator(e){return!isTextNode(e)&&"emails-editor-separator"===e.className}var EmailsEditor=function(e,t){var i=this,n=void 0===t?{}:t,r=n.className,a=void 0===r?"":r,o=n.emails,s=void 0===o?[]:o;_defineProperty(this,"adjustSelection",(function(){if(i.isFocused){var e=window.getSelection().anchorNode;if(e&&e!==i.input&&i.input.contains(e)){var t=isTextNode(e)?e.parentElement:e;if("emails-editor-separator"===t.className)nodeListToArray(i.input.childNodes).indexOf(t)}requestAnimationFrame(i.adjustSelection)}})),_defineProperty(this,"getSelection",(function(){var e=nodeListToArray(i.input.childNodes),t=window.getSelection(),n=t.anchorNode,r=t.anchorOffset,a=t.focusNode,o=t.focusOffset;if(!i.input.contains(n))return{start:null,end:null};if(n!==i.input){for(;-1===e.indexOf(n);)n=n.parentNode;r=e.indexOf(n)}if(a!==i.input){for(;-1===e.indexOf(a);)a=a.parentNode;o=e.indexOf(a)}var s=Math.min(r,o),l=Math.max(r,o);return{start:s=e.slice(0,s).filter((function(e){return!isEmailSeparator(e)})).length,end:l=e.slice(0,l).filter((function(e){return!isEmailSeparator(e)})).length}})),_defineProperty(this,"setCursorAtEmailIndex",(function(e){var t=document.createRange(),n=window.getSelection(),r=nodeListToArray(i.input.childNodes),a=nodeListToArray(i.input.querySelectorAll(".emails-editor__email"))[e],o=a?r.indexOf(a):r.length-1;t.setStart(i.input,o),t.collapse(!0),n.removeAllRanges(),n.addRange(t)})),_defineProperty(this,"parseEmails",(function(){return nodeListToArray(i.input.childNodes).reduce((function(e,t){var i=(isTextNode(t)?t.textContent:t.innerText).replace(/[\s,]+/," ").split(" ").filter((function(e){return!!e.trim()}));return e.concat(i)}),[])})),_defineProperty(this,"format",(function(){i.emails=i.parseEmails();var e=nodeListToArray(i.input.childNodes);var t=i.getSelection().start;e.reduce((function(e,i,n){var r=(isTextNode(i)?i.textContent:i.innerText).replace(/[\s,]+/," ").split(" ").filter((function(e){return!!e.trim()}));return isTextNode(i)&&(t=e.length+r.length-1),e.concat(r)}),[]);var n=i.emails.map((function(e){return'<span contenteditable="false" class="'+["emails-editor__email",validateEmail(e)?"emails-editor__email--valid":"emails-editor__email--invalid"].join(" ")+'">'+escapeHtml(e)+'<span class="emails-editor__email-btn-remove"></span></span>'})).join(SEPARATOR);i.input.innerHTML=n?SEPARATOR+n+SEPARATOR:SEPARATOR,nodeListToArray(i.input.querySelectorAll(".emails-editor__email-btn-remove")).forEach((function(e){e.addEventListener("click",i.onEmailRemoveClick)})),i.isFocused&&null!==t&&i.setCursorAtEmailIndex(t+1)})),_defineProperty(this,"formatIfNeeded",(function(){var e=nodeListToArray(i.input.childNodes).filter((function(e){return isTextNode(e)||"emails-editor-separator"!==e.className})).map((function(e){return isTextNode(e)?e.textContent:e.innerText})).join("");/[\s,]/.test(e)&&i.format()})),_defineProperty(this,"onEmailRemoveClick",(function(e){var t=i.getSelection().start,n=e.target.parentElement;i.input.removeChild(n),i.emails=i.parseEmails(),i.format(),t&&i.setCursorAtEmailIndex(t)})),_defineProperty(this,"onFocus",(function(){i.isFocused=!0,i.adjustSelection()})),_defineProperty(this,"onBlur",(function(){i.isFocused=!1,i.format()})),_defineProperty(this,"onKeyDown",(function(e){if(e.keyCode===ENTER_KEY)e.preventDefault(),i.format();else if(e.keyCode===BACKSPACE_KEY){e.preventDefault();var t=i.getSelection(),n=t.start===t.end,r=[].concat(n?i.emails.slice(0,t.start).slice(0,-1):i.emails.slice(0,t.start),i.emails.slice(t.end));i.input.innerText=r.join(" "),i.format(),i.setCursorAtEmailIndex(t.start)}})),_defineProperty(this,"onPaste",(function(e){e.preventDefault();var t=e.clipboardData.getData("text"),n=i.getSelection(),r=n.start,a=n.end;i.input.innerHTML=i.input.innerHTML.slice(0,r)+escapeHtml(t)+i.input.innerHTML.slice(a),i.emails=i.parseEmails(),i.formatIfNeeded()})),_defineProperty(this,"onInput",(function(){i.emails=i.parseEmails(),i.formatIfNeeded()}));var l=document.createElement("div");l.className=["emails-editor",a].join(" "),l.innerText=s.join(" "),l.contentEditable=!0,l.addEventListener("input",this.onInput),l.addEventListener("paste",this.onPaste),l.addEventListener("click",this.onClick),l.addEventListener("focus",this.onFocus),l.addEventListener("blur",this.onBlur),l.addEventListener("keydown",this.onKeyDown),this.input=l,this.emails=s,this.format(),this.isFocused=!1,e.append(l)};module.exports=EmailsEditor;
